import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import fsolve

# üéØ –û–î–£: dy/dx = -2y + x^2
def f(x, y):
    return -2 * y + x**2

# üéØ –¢–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)
def y_exact(x):
    return 0.25 * (x**2 - 2*x + 2) * np.exp(-2*x) + 0.25 * (x**2 + 2*x + 1)

# üéØ –ù–µ—è–≤–Ω—ã–π –º–µ—Ç–æ–¥ –≠–π–ª–µ—Ä–∞
def implicit_euler(f, x0, y0, h, x_end):
    x_values = np.arange(x0, x_end + h, h)  # –®–∞–≥–∏ —Ä–∞–∑–±–∏–µ–Ω–∏—è
    y_values = np.zeros_like(x_values)
    y_values[0] = y0  # –ù–∞—á–∞–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ

    for i in range(1, len(x_values)):
        x_n = x_values[i - 1]
        y_n = y_values[i - 1]
        x_next = x_values[i]

        # –†–µ—à–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ y_next - y_n - h*f(x_next, y_next) = 0
        def equation(y_next):
            return y_next - y_n - h * f(x_next, y_next)

        y_next_guess = y_n  # –ù–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
        y_values[i] = fsolve(equation, y_next_guess)[0]  # –ß–∏—Å–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

    return x_values, y_values

# üîπ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—á–∏
x0, y0 = 0, 1  # –ù–∞—á–∞–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ y(0) = 1
x_end = 2       # –ö–æ–Ω–µ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ x
h = 0.2         # –û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥

# üîπ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
x_h, y_h = implicit_euler(f, x0, y0, h, x_end)
x_h2, y_h2 = implicit_euler(f, x0, y0, h / 2, x_end)  # h/2

# üîπ –¢–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
x_exact = np.linspace(x0, x_end, 1000)
y_exact_vals = y_exact(x_exact)

# üîπ –û—Ü–µ–Ω–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
error_h = np.abs(y_h2[::2] - y_h)  # –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É h/2 –∏ h
order_accuracy = np.log2(np.mean(error_h[:-1] / error_h[1:]))  # –û—Ü–µ–Ω–∫–∞ –ø–æ—Ä—è–¥–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏

# üìä **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤**
plt.figure(figsize=(10, 6))
plt.plot(x_exact, y_exact_vals, 'k-', label="–¢–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ")
plt.plot(x_h, y_h, 'ro-', label=f"–ú–µ—Ç–æ–¥ –≠–π–ª–µ—Ä–∞ (h={h})")
plt.plot(x_h2, y_h2, 'bs--', label=f"–ú–µ—Ç–æ–¥ –≠–π–ª–µ—Ä–∞ (h={h/2})")

plt.xlabel("x")
plt.ylabel("y")
plt.title("–ß–∏—Å–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –û–î–£ –Ω–µ—è–≤–Ω—ã–º –º–µ—Ç–æ–¥–æ–º –≠–π–ª–µ—Ä–∞")
plt.legend()
plt.grid()

# ‚ú® **–î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –≥—Ä–∞—Ñ–∏–∫**
plt.text(0.5, 0.3, f"–ü–æ—Ä—è–¥–æ–∫ —Ç–æ—á–Ω–æ—Å—Ç–∏: {order_accuracy:.2f}",
         fontsize=12, color="black", bbox=dict(facecolor='white', alpha=0.7))

# üìÅ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Ñ–∞–π–ª**
plot_file = "D:/implicit_euler_plot.png"
plt.savefig(plot_file, dpi=300)

print(f"–ì—Ä–∞—Ñ–∏–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ {plot_file}")

plt.show()
